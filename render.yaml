services:
  # 1. Java Backend (ISMS Core)
  - type: web
    name: sparksbm-core
    runtime: docker
    dockerContext: .
    dockerfilePath: Dockerfile.core
    plan: starter # Java needs more RAM than free tier usually offers
    envVars:
      - key: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://ep-young-bread-a1f8nuq1-pooler.ap-southeast-1.aws.neon.tech/SparksBM?sslmode=require
      - key: SPRING_DATASOURCE_USERNAME
        value: neondb_owner
      - key: SPRING_DATASOURCE_PASSWORD
        value: npg_UYhru41qVIZS
      - key: KEYCLOAK_AUTH_SERVER_URL
        value: https://${KEYCLOAK_HOST}
      - key: KEYCLOAK_HOST
        fromService:
          type: web
          name: sparksbm-auth
          property: host
      - key: SPRING_SECURITY_OAUTH2_ISSUER_URI
        value: https://sparksbm-auth.onrender.com/realms/sparksbm
      - key: SPRING_SECURITY_OAUTH2_JWK_SET_URI
        value: https://sparksbm-auth.onrender.com/realms/sparksbm/protocol/openid-connect/certs
      - key: VEO_CORS_ORIGINS
        value: https://sparksbm-web.onrender.com
      - key: SPRING_RABBITMQ_HOST
        fromService:
          type: pserv
          name: sparksbm-queue
          property: host

  # 2. Keycloak (Authentication)
  - type: web
    name: sparksbm-auth
    runtime: docker
    dockerfilePath: ./k8s/keycloak.dockerfile
    plan: starter
    envVars:
      - key: KC_DB
        value: postgres
      # Must be JDBC URL (jdbc:postgresql://...), NOT a psql command. In Neon: CREATE DATABASE keycloak on same branch.
      - key: KC_DB_URL
        value: jdbc:postgresql://ep-young-bread-a1f8nuq1-pooler.ap-southeast-1.aws.neon.tech/keycloak?sslmode=require
      - key: KC_DB_USERNAME
        value: neondb_owner
      - key: KC_DB_PASSWORD
        value: npg_UYhru41qVIZS
      # Public hostname for redirects (Render default: service-name.onrender.com)
      - key: KC_HOSTNAME
        value: sparksbm-auth.onrender.com
      - key: KC_PROXY_HEADERS
        value: xforwarded
      - key: KEYCLOAK_ADMIN
        value: admin
      - key: KEYCLOAK_ADMIN_PASSWORD
        value: admin123

  # 3. Python Agent (NotebookLLM API)
  - type: web
    name: sparksbm-agent
    runtime: docker
    dockerContext: .
    dockerfilePath: NotebookLLM/api/Dockerfile
    envVars:
      - key: API_PORT
        value: 8000
      - key: GEMINI_API_KEY
        sync: false
      - key: CORS_ORIGINS
        value: https://notebookllm-aukc.onrender.com,https://sparksbm-web.onrender.com
      - key: VERINICE_API_URL
        value: https://sparksbm-core.onrender.com
      - key: KEYCLOAK_URL
        value: https://sparksbm-auth.onrender.com
      - key: KEYCLOAK_REALM
        value: sparksbm
      - key: SPARKSBM_USERNAME
        value: admin@sparksbm.com
      - key: SPARKSBM_PASSWORD
        value: admin123

  # 4. SparksBM-Web (ISMS dashboard) â€“ set build env so redirect and unit/domain work
  - type: web
    name: sparksbm-web
    runtime: docker
    dockerContext: .
    dockerfilePath: SparksbmISMS/verinice-veo-web/Dockerfile
    envVars:
      - key: NOTEBOOKLLM_API_URL
        value: https://sparksbm-agent.onrender.com
      - key: VEO_DEFAULT_API_URL
        value: https://sparksbm-core.onrender.com
      - key: VEO_OIDC_URL
        value: https://sparksbm-auth.onrender.com/auth
      - key: VEO_OIDC_REALM
        value: sparksbm
      - key: VEO_OIDC_CLIENT
        value: sparksbm
      - key: VEO_ACCOUNT_PATH
        value: https://sparksbm-auth.onrender.com/auth/realms/sparksbm/account
      - key: VEO_OIDC_ACCOUNT_APPLICATION
        value: https://sparksbm-auth.onrender.com/auth/realms/sparksbm/account

  # 5. RabbitMQ (Queue)
  - type: pserv
    name: sparksbm-queue
    runtime: docker
    dockerfilePath: ./k8s/rabbitmq.dockerfile
